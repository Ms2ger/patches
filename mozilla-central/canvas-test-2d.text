From: Ms2ger <ms2ger@gmail.com>
Bug 665345 - Import some 2d.text.* tests to improve test coverage

diff --git a/content/canvas/test/CanvasTest.ttf b/content/canvas/test/CanvasTest.ttf
new file mode 100644
index 0000000000000000000000000000000000000000..9023592ef5aa83a03dd6957398897a585062ca57
GIT binary patch
literal 2528
zc%0o<-)mb{9RHkqZ*H2d+d5qBWD)MVZrx<PNmH>}`p~Uy*lf#6mlc#@cTH|{14(X3
zZu$cREAC-d#!&Frzc6*MA}Br#8M+Ob$Y5{t!3R-LCwtHrNgF@s=C;eGvOS9DaPs~A
z^W1YzAOLK`GE|&Ca`?p9pHC|ZAo2>iN0Z6a<jE^5*GYd#I(qy>Eb)SvivhwRJ(Dh2
zrQP1Pane6<ol4Jp2D+59fI3XMmbEISdYzsT@kqC1^GkEXy~*b(KMg3$j%{V`UOw^!
zWxsMg<B$<4t$#va-K4vng16ZAZ0$|bUy$y~yJ<_ktV#c)GM|FASi&?WDL+cuC|U)3
zef-_8fYA5UiI?1px2yX}h4I@d&p_77rQe;Y&Tb$216wr6aqZ&zXB)8AQM;`l(r?Oq
zp`bCO&CS|voYGM1Si7Yk@;x;V&F5@IR94HO_*RlP471^bD!(H{(Fe*6(&rmc{DOWF
zkp_BX)7yRCr{=~o^b*0CiaKygzp3uKr^5=m0vMGmn8B!Z1c(}}Xka%(O8B&fLBG~U
zwOe6ejC;nG5j!lg`cL(1)NR@Hq_GNJY76~dszTL5`bNK+>ImZ@qb1V1rR`x#|KZ_(
z?|6!H6fa>BZ{s7*&v6wskr2b|6Zc0Xlnd-!80IB`*wAWN!=1z>J@nnss;UshB~`LR
zlD!(%MQvzRNPhp0Jv(~(ckJyF?Z4f)p<Gy-=~CuoU!x)_zE$pE3-H)L=Rjw;Gu#vI
z8Hgs&zj|_cW$KOjaaTDrd+xoH@0^`oS$Xly|Ir5Wt5^N+nr+&{vq^MKvMH;>Kiib`
z1+uzN)oyD%%Z#%fyQ$a|OHePgLG%oCid{{?*H23qN`8Yrn>?>OP5G>K)sWgCR%XvJ
zR;{BB{SZU`ODxe8tJcvJOHIpIp>LXEi7QR9#B~;Wyg67<?}NRlHNMboxVU*ttGsC&
zxIn8|3~*jP;;jHzv0wZc;2K($y#XFVyD}BvI{6Fo2GQi5^|Nm!ae<xU<p5XECSDJ4
z6%*q90N1cn*&5&>7>XI-I{6kx;G%>jl#xRg4m{pM2av`=!UW>z<1#QsNe+3g5~&m{
zTI6Y2=3U#$ISre%O@4*H8R}F~B($kv(5FMp;Ja~*wgx8XCrwV#*B&HC#`WlX5HZdL
zf0}+~4K0`c%D#>1N6k_zf1j5MIR$b&^gbXl>BZr~h+A4J=dzAx97rED67jycG3Dg)
zxss8xmhx`dY;B#k^R`v7Ge)(TvCD?%*v90slrfP@+r^4KXgHo%8jQsj78XpmM3!4E
zr)|?MXJh$>N+njvdA$K)mK+(DT`6MT?@h|jlyCEhRh+jfDZ4^^(r;OgB^F57nOv1H
z$vTVFOa}GZ{(hMLZpe=Plh=kMfdTd);jhO2A?X&qB(t=Qgc&ymjeF5aBnEmDy|NpR
zkm`)TqZKAAvoq*hMlgLSGsBEsuH@XJ5s&wo@p#;L1fRhhR(}osz~A0^`9hK_6rl=D
zg!lrg=*B+mM-L8!tHm6nj0W(z03HtDkpPZJ4}4h_-+POH&K`&6SjB8EW4i^*bINX^
v2r-(RNKvi_=Tbu(+OZS6AmroA|7=1mZ=Pn3tM;c~OL*<$Thl(gxc=c^AdA6v

diff --git a/content/canvas/test/Makefile.in b/content/canvas/test/Makefile.in
--- a/content/canvas/test/Makefile.in
+++ b/content/canvas/test/Makefile.in
@@ -10,16 +10,17 @@ VPATH		= @srcdir@
 relativesrcdir  = @relativesrcdir@
 
 include $(DEPTH)/config/autoconf.mk
 MOCHITEST_FILES = \
 	canvas-tests.js \
 	test_canvas.html \
 	test_canvas_mozilla.html \
 	test_isPointInStroke.html \
+	CanvasTest.ttf \
 	image_transparent50.png \
 	image_redtransparent.png \
 	image_yellow.png \
 	image_anim-poster-gr.png \
 	image_green-16x16.png \
 	image_red-16x16.png \
 	image_green-1x1.png \
 	image_ggrr-256x256.png \
@@ -135,16 +136,43 @@ MOCHITEST_FILES += \
   test_2d.transformation.transform.skewed.html \
   $(NULL)
 
 # Tests that use setTimeout.
 MOCHITEST_FILES += \
   test_2d.drawImage.animated.apng.html \
   test_2d.drawImage.animated.gif.html \
   test_2d.pattern.animated.gif.html \
+  test_2d.text.draw.align.center.html \
+  test_2d.text.draw.align.end.ltr.html \
+  test_2d.text.draw.align.end.rtl.html \
+  test_2d.text.draw.align.left.html \
+  test_2d.text.draw.align.right.html \
+  test_2d.text.draw.align.start.ltr.html \
+  test_2d.text.draw.align.start.rtl.html \
+  test_2d.text.draw.baseline.alphabetic.html \
+  test_2d.text.draw.baseline.bottom.html \
+  test_2d.text.draw.baseline.hanging.html \
+  test_2d.text.draw.baseline.ideographic.html \
+  test_2d.text.draw.baseline.middle.html \
+  test_2d.text.draw.baseline.top.html \
+  test_2d.text.draw.fill.maxWidth.bound.html \
+  test_2d.text.draw.fill.maxWidth.fontface.html \
+  test_2d.text.draw.fontface.html \
+  test_2d.text.draw.fontface.notinpage.html \
+  test_2d.text.draw.fontface.repeat.html \
+  test_2d.text.draw.space.basic.html \
+  test_2d.text.draw.space.collapse.end.html \
+  test_2d.text.draw.space.collapse.nonspace.html \
+  test_2d.text.draw.space.collapse.other.html \
+  test_2d.text.draw.space.collapse.space.html \
+  test_2d.text.draw.space.collapse.start.html \
+  test_2d.text.measure.width.basic.html \
+  test_2d.text.measure.width.empty.html \
+  test_2d.text.measure.width.space.html \
   $(NULL)
 
 # Tests that use events.
 MOCHITEST_FILES += \
   test_2d.pattern.modify.image1.html \
   test_2d.pattern.modify.image2.html \
   test_toDataURL.jpeg.alpha.html \
   test_toDataURL.jpeg.primarycolours.html \
diff --git a/content/canvas/test/standalone.dat b/content/canvas/test/standalone.dat
--- a/content/canvas/test/standalone.dat
+++ b/content/canvas/test/standalone.dat
@@ -68,16 +68,43 @@ test_2d.path.stroke.prune.curve.html
 test_2d.path.stroke.prune.line.html
 test_2d.path.stroke.prune.rect.html
 test_2d.transformation.setTransform.skewed.html
 test_2d.transformation.transform.skewed.html
 # setTimeout
 test_2d.drawImage.animated.apng.html
 test_2d.drawImage.animated.gif.html
 test_2d.pattern.animated.gif.html
+test_2d.text.draw.align.center.html
+test_2d.text.draw.align.end.ltr.html
+test_2d.text.draw.align.end.rtl.html
+test_2d.text.draw.align.left.html
+test_2d.text.draw.align.right.html
+test_2d.text.draw.align.start.ltr.html
+test_2d.text.draw.align.start.rtl.html
+test_2d.text.draw.baseline.alphabetic.html
+test_2d.text.draw.baseline.bottom.html
+test_2d.text.draw.baseline.hanging.html
+test_2d.text.draw.baseline.ideographic.html
+test_2d.text.draw.baseline.middle.html
+test_2d.text.draw.baseline.top.html
+test_2d.text.draw.fill.maxWidth.bound.html
+test_2d.text.draw.fill.maxWidth.fontface.html
+test_2d.text.draw.fontface.html
+test_2d.text.draw.fontface.notinpage.html
+test_2d.text.draw.fontface.repeat.html
+test_2d.text.draw.space.basic.html
+test_2d.text.draw.space.collapse.end.html
+test_2d.text.draw.space.collapse.nonspace.html
+test_2d.text.draw.space.collapse.other.html
+test_2d.text.draw.space.collapse.space.html
+test_2d.text.draw.space.collapse.start.html
+test_2d.text.measure.width.basic.html
+test_2d.text.measure.width.empty.html
+test_2d.text.measure.width.space.html
 # Events
 test_2d.pattern.modify.image1.html
 test_2d.pattern.modify.image2.html
 test_toDataURL.jpeg.alpha.html
 test_toDataURL.jpeg.primarycolours.html
 test_toDataURL.jpeg.quality.basic.html
 test_toDataURL.png.complexcolours.html
 test_toDataURL.png.primarycolours.html
diff --git a/content/canvas/test/test_2d.text.draw.align.center.html b/content/canvas/test/test_2d.text.draw.align.center.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.align.center.html
@@ -0,0 +1,43 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.align.center</title>
+<!-- Testing: textAlign center is the center of the em squares (not the bounding box) -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.textAlign = 'center';
+    ctx.fillText('DD', 50, 37.5);
+    isPixel(ctx, 5,5, 0,255,0,255, "5,5", "0,255,0,255", 2);
+    isPixel(ctx, 95,5, 0,255,0,255, "95,5", "0,255,0,255", 2);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+    isPixel(ctx, 5,45, 0,255,0,255, "5,45", "0,255,0,255", 2);
+    isPixel(ctx, 95,45, 0,255,0,255, "95,45", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.align.end.ltr.html b/content/canvas/test/test_2d.text.draw.align.end.ltr.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.align.end.ltr.html
@@ -0,0 +1,43 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.align.end.ltr</title>
+<!-- Testing: textAlign end with ltr is the right edge -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50" dir="ltr"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.textAlign = 'end';
+    ctx.fillText('DD', 100, 37.5);
+    isPixel(ctx, 5,5, 0,255,0,255, "5,5", "0,255,0,255", 2);
+    isPixel(ctx, 95,5, 0,255,0,255, "95,5", "0,255,0,255", 2);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+    isPixel(ctx, 5,45, 0,255,0,255, "5,45", "0,255,0,255", 2);
+    isPixel(ctx, 95,45, 0,255,0,255, "95,45", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.align.end.rtl.html b/content/canvas/test/test_2d.text.draw.align.end.rtl.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.align.end.rtl.html
@@ -0,0 +1,43 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.align.end.rtl</title>
+<!-- Testing: textAlign end with rtl is the left edge -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50" dir="rtl"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.textAlign = 'end';
+    ctx.fillText('DD', 0, 37.5);
+    isPixel(ctx, 5,5, 0,255,0,255, "5,5", "0,255,0,255", 2);
+    isPixel(ctx, 95,5, 0,255,0,255, "95,5", "0,255,0,255", 2);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+    isPixel(ctx, 5,45, 0,255,0,255, "5,45", "0,255,0,255", 2);
+    isPixel(ctx, 95,45, 0,255,0,255, "95,45", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.align.left.html b/content/canvas/test/test_2d.text.draw.align.left.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.align.left.html
@@ -0,0 +1,43 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.align.left</title>
+<!-- Testing: textAlign left is the left of the first em square (not the bounding box) -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.textAlign = 'left';
+    ctx.fillText('DD', 0, 37.5);
+    isPixel(ctx, 5,5, 0,255,0,255, "5,5", "0,255,0,255", 2);
+    isPixel(ctx, 95,5, 0,255,0,255, "95,5", "0,255,0,255", 2);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+    isPixel(ctx, 5,45, 0,255,0,255, "5,45", "0,255,0,255", 2);
+    isPixel(ctx, 95,45, 0,255,0,255, "95,45", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.align.right.html b/content/canvas/test/test_2d.text.draw.align.right.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.align.right.html
@@ -0,0 +1,43 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.align.right</title>
+<!-- Testing: textAlign right is the right of the last em square (not the bounding box) -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.textAlign = 'right';
+    ctx.fillText('DD', 100, 37.5);
+    isPixel(ctx, 5,5, 0,255,0,255, "5,5", "0,255,0,255", 2);
+    isPixel(ctx, 95,5, 0,255,0,255, "95,5", "0,255,0,255", 2);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+    isPixel(ctx, 5,45, 0,255,0,255, "5,45", "0,255,0,255", 2);
+    isPixel(ctx, 95,45, 0,255,0,255, "95,45", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.align.start.ltr.html b/content/canvas/test/test_2d.text.draw.align.start.ltr.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.align.start.ltr.html
@@ -0,0 +1,43 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.align.start.ltr</title>
+<!-- Testing: textAlign start with ltr is the left edge -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50" dir="ltr"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.textAlign = 'start';
+    ctx.fillText('DD', 0, 37.5);
+    isPixel(ctx, 5,5, 0,255,0,255, "5,5", "0,255,0,255", 2);
+    isPixel(ctx, 95,5, 0,255,0,255, "95,5", "0,255,0,255", 2);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+    isPixel(ctx, 5,45, 0,255,0,255, "5,45", "0,255,0,255", 2);
+    isPixel(ctx, 95,45, 0,255,0,255, "95,45", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.align.start.rtl.html b/content/canvas/test/test_2d.text.draw.align.start.rtl.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.align.start.rtl.html
@@ -0,0 +1,43 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.align.start.rtl</title>
+<!-- Testing: textAlign start with rtl is the right edge -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50" dir="rtl"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.textAlign = 'start';
+    ctx.fillText('DD', 100, 37.5);
+    isPixel(ctx, 5,5, 0,255,0,255, "5,5", "0,255,0,255", 2);
+    isPixel(ctx, 95,5, 0,255,0,255, "95,5", "0,255,0,255", 2);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+    isPixel(ctx, 5,45, 0,255,0,255, "5,45", "0,255,0,255", 2);
+    isPixel(ctx, 95,45, 0,255,0,255, "95,45", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.baseline.alphabetic.html b/content/canvas/test/test_2d.text.draw.baseline.alphabetic.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.baseline.alphabetic.html
@@ -0,0 +1,42 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.baseline.alphabetic</title>
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.textBaseline = 'alphabetic';
+    ctx.fillText('CC', 0, 37.5);
+    isPixel(ctx, 5,5, 0,255,0,255, "5,5", "0,255,0,255", 2);
+    isPixel(ctx, 95,5, 0,255,0,255, "95,5", "0,255,0,255", 2);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+    isPixel(ctx, 5,45, 0,255,0,255, "5,45", "0,255,0,255", 2);
+    isPixel(ctx, 95,45, 0,255,0,255, "95,45", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.baseline.bottom.html b/content/canvas/test/test_2d.text.draw.baseline.bottom.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.baseline.bottom.html
@@ -0,0 +1,43 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.baseline.bottom</title>
+<!-- Testing: textBaseline bottom is the bottom of the em square (not the bounding box) -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.textBaseline = 'bottom';
+    ctx.fillText('CC', 0, 50);
+    isPixel(ctx, 5,5, 0,255,0,255, "5,5", "0,255,0,255", 2);
+    isPixel(ctx, 95,5, 0,255,0,255, "95,5", "0,255,0,255", 2);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+    isPixel(ctx, 5,45, 0,255,0,255, "5,45", "0,255,0,255", 2);
+    isPixel(ctx, 95,45, 0,255,0,255, "95,45", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.baseline.hanging.html b/content/canvas/test/test_2d.text.draw.baseline.hanging.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.baseline.hanging.html
@@ -0,0 +1,42 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.baseline.hanging</title>
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.textBaseline = 'hanging';
+    ctx.fillText('CC', 0, 12.5);
+    todo_isPixel(ctx, 5,5, 0,255,0,255, "5,5", "0,255,0,255", 2);
+    todo_isPixel(ctx, 95,5, 0,255,0,255, "95,5", "0,255,0,255", 2);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+    isPixel(ctx, 5,45, 0,255,0,255, "5,45", "0,255,0,255", 2);
+    isPixel(ctx, 95,45, 0,255,0,255, "95,45", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.baseline.ideographic.html b/content/canvas/test/test_2d.text.draw.baseline.ideographic.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.baseline.ideographic.html
@@ -0,0 +1,42 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.baseline.ideographic</title>
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.textBaseline = 'ideographic';
+    ctx.fillText('CC', 0, 31.25);
+    isPixel(ctx, 5,5, 0,255,0,255, "5,5", "0,255,0,255", 2);
+    isPixel(ctx, 95,5, 0,255,0,255, "95,5", "0,255,0,255", 2);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+    todo_isPixel(ctx, 5,45, 0,255,0,255, "5,45", "0,255,0,255", 2);
+    todo_isPixel(ctx, 95,45, 0,255,0,255, "95,45", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.baseline.middle.html b/content/canvas/test/test_2d.text.draw.baseline.middle.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.baseline.middle.html
@@ -0,0 +1,43 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.baseline.middle</title>
+<!-- Testing: textBaseline middle is the middle of the em square (not the bounding box) -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.textBaseline = 'middle';
+    ctx.fillText('CC', 0, 25);
+    isPixel(ctx, 5,5, 0,255,0,255, "5,5", "0,255,0,255", 2);
+    isPixel(ctx, 95,5, 0,255,0,255, "95,5", "0,255,0,255", 2);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+    isPixel(ctx, 5,45, 0,255,0,255, "5,45", "0,255,0,255", 2);
+    isPixel(ctx, 95,45, 0,255,0,255, "95,45", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.baseline.top.html b/content/canvas/test/test_2d.text.draw.baseline.top.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.baseline.top.html
@@ -0,0 +1,43 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.baseline.top</title>
+<!-- Testing: textBaseline top is the top of the em square (not the bounding box) -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.textBaseline = 'top';
+    ctx.fillText('CC', 0, 0);
+    isPixel(ctx, 5,5, 0,255,0,255, "5,5", "0,255,0,255", 2);
+    isPixel(ctx, 95,5, 0,255,0,255, "95,5", "0,255,0,255", 2);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+    isPixel(ctx, 5,45, 0,255,0,255, "5,45", "0,255,0,255", 2);
+    isPixel(ctx, 95,45, 0,255,0,255, "95,45", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.fill.maxWidth.bound.html b/content/canvas/test/test_2d.text.draw.fill.maxWidth.bound.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.fill.maxWidth.bound.html
@@ -0,0 +1,40 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.fill.maxWidth.bound</title>
+<!-- Testing: fillText handles maxWidth based on line size, not bounding box size -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.fillText('DD', 0, 37.5, 100);
+    isPixel(ctx, 5,5, 0,255,0,255, "5,5", "0,255,0,255", 2);
+    isPixel(ctx, 95,5, 0,255,0,255, "95,5", "0,255,0,255", 2);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.fill.maxWidth.fontface.html b/content/canvas/test/test_2d.text.draw.fill.maxWidth.fontface.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.fill.maxWidth.fontface.html
@@ -0,0 +1,40 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.fill.maxWidth.fontface</title>
+<!-- Testing: fillText works on @font-face fonts -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#0f0';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#f00';
+    ctx.fillText('EEEE', -50, 37.5, 40);
+    isPixel(ctx, 5,5, 0,255,0,255, "5,5", "0,255,0,255", 2);
+    isPixel(ctx, 95,5, 0,255,0,255, "95,5", "0,255,0,255", 2);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.fontface.html b/content/canvas/test/test_2d.text.draw.fontface.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.fontface.html
@@ -0,0 +1,39 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.fontface</title>
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '67px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.fillText('AA', 0, 50);
+    isPixel(ctx, 5,5, 0,255,0,255, "5,5", "0,255,0,255", 2);
+    isPixel(ctx, 95,5, 0,255,0,255, "95,5", "0,255,0,255", 2);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.fontface.notinpage.html b/content/canvas/test/test_2d.text.draw.fontface.notinpage.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.fontface.notinpage.html
@@ -0,0 +1,39 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.fontface.notinpage</title>
+<!-- Testing: @font-face fonts should work even if they are not used in the page -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '67px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.fillText('AA', 0, 50);
+    todo_isPixel(ctx, 5,5, 0,255,0,255, "5,5", "0,255,0,255", 2);
+    todo_isPixel(ctx, 95,5, 0,255,0,255, "95,5", "0,255,0,255", 2);
+    todo_isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    todo_isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.fontface.repeat.html b/content/canvas/test/test_2d.text.draw.fontface.repeat.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.fontface.repeat.html
@@ -0,0 +1,40 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.fontface.repeat</title>
+<!-- Testing: Draw with the font immediately, then wait a bit until and draw again. (This crashes some version of WebKit.) -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.fillStyle = '#f00';
+ctx.fillRect(0, 0, 100, 50);
+ctx.font = '67px CanvasTest';
+ctx.fillStyle = '#0f0';
+ctx.fillText('AA', 0, 50);
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillText('AA', 0, 50);
+    isPixel(ctx, 5,5, 0,255,0,255, "5,5", "0,255,0,255", 2);
+    isPixel(ctx, 95,5, 0,255,0,255, "95,5", "0,255,0,255", 2);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.space.basic.html b/content/canvas/test/test_2d.text.draw.space.basic.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.space.basic.html
@@ -0,0 +1,38 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.space.basic</title>
+<!-- Testing: U+0020 is rendered the correct size (1em wide) -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.fillText('E EE', -100, 37.5);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.space.collapse.end.html b/content/canvas/test/test_2d.text.draw.space.collapse.end.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.space.collapse.end.html
@@ -0,0 +1,39 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.space.collapse.end</title>
+<!-- Testing: Space characters at the end of a line are collapsed (per CSS) -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.textAlign = 'right';
+    ctx.fillText('EE ', 100, 37.5);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    todo_isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.space.collapse.nonspace.html b/content/canvas/test/test_2d.text.draw.space.collapse.nonspace.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.space.collapse.nonspace.html
@@ -0,0 +1,38 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.space.collapse.nonspace</title>
+<!-- Testing: Non-space characters are not converted to U+0020 and collapsed -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.fillText('E\x0b EE', -150, 37.5);
+    isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.space.collapse.other.html b/content/canvas/test/test_2d.text.draw.space.collapse.other.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.space.collapse.other.html
@@ -0,0 +1,38 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.space.collapse.other</title>
+<!-- Testing: Space characters are converted to U+0020, and collapsed (per CSS) -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.fillText('E \x09\x0a\x0c\x0d  \x09\x0a\x0c\x0dEE', -100, 37.5);
+    todo_isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    todo_isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.space.collapse.space.html b/content/canvas/test/test_2d.text.draw.space.collapse.space.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.space.collapse.space.html
@@ -0,0 +1,38 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.space.collapse.space</title>
+<!-- Testing: Space characters are converted to U+0020, and collapsed (per CSS) -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.fillText('E  EE', -100, 37.5);
+    todo_isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.draw.space.collapse.start.html b/content/canvas/test/test_2d.text.draw.space.collapse.start.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.draw.space.collapse.start.html
@@ -0,0 +1,38 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.draw.space.collapse.start</title>
+<!-- Testing: Space characters at the start of a line are collapsed (per CSS) -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+ctx.font = '50px CanvasTest';
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.fillStyle = '#f00';
+    ctx.fillRect(0, 0, 100, 50);
+    ctx.fillStyle = '#0f0';
+    ctx.fillText(' EE', 0, 37.5);
+    todo_isPixel(ctx, 25,25, 0,255,0,255, "25,25", "0,255,0,255", 2);
+    isPixel(ctx, 75,25, 0,255,0,255, "75,25", "0,255,0,255", 2);
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.measure.width.basic.html b/content/canvas/test/test_2d.text.measure.width.basic.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.measure.width.basic.html
@@ -0,0 +1,37 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.measure.width.basic</title>
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.font = '50px CanvasTest';
+    ok(ctx.measureText('A').width === 50, "ctx.measureText('A').width === 50");
+    ok(ctx.measureText('AA').width === 100, "ctx.measureText('AA').width === 100");
+    ok(ctx.measureText('ABCD').width === 200, "ctx.measureText('ABCD').width === 200");
+
+    ctx.font = '100px CanvasTest';
+    ok(ctx.measureText('A').width === 100, "ctx.measureText('A').width === 100");
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.measure.width.empty.html b/content/canvas/test/test_2d.text.measure.width.empty.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.measure.width.empty.html
@@ -0,0 +1,33 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.measure.width.empty</title>
+<!-- Testing: The empty string has zero width -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.font = '50px CanvasTest';
+    ok(ctx.measureText("").width === 0, "ctx.measureText(\"\").width === 0");
+}), 500);
+
+
+});
+</script>
+
diff --git a/content/canvas/test/test_2d.text.measure.width.space.html b/content/canvas/test/test_2d.text.measure.width.space.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_2d.text.measure.width.space.html
@@ -0,0 +1,39 @@
+<!DOCTYPE HTML>
+<title>Canvas test: 2d.text.measure.width.space</title>
+<!-- Testing: Space characters are converted to U+0020 and collapsed (per CSS) -->
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script src="canvas-tests.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+@font-face {
+  font-family: CanvasTest;
+  src: url("CanvasTest.ttf");
+}
+</style>
+<body>
+<span style="font-family: CanvasTest; position: absolute; visibility: hidden">A</span>
+<canvas id="c" width="100" height="50"><p class="fallback">FAIL (fallback content)</p></canvas>
+<script>
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(function () {
+
+var canvas = document.getElementById('c');
+var ctx = canvas.getContext('2d');
+
+deferTest();
+setTimeout(wrapFunction(function () {
+    ctx.font = '50px CanvasTest';
+    ok(ctx.measureText('A B').width === 150, "ctx.measureText('A B').width === 150");
+    todo(ctx.measureText('A  B').width === 150, "ctx.measureText('A  B').width === 150");
+    todo(ctx.measureText('A \x09\x0a\x0c\x0d  \x09\x0a\x0c\x0dB').width === 150, "ctx.measureText('A \\x09\\x0a\\x0c\\x0d  \\x09\\x0a\\x0c\\x0dB').width === 150");
+    ok(ctx.measureText('A \x0b B').width >= 200, "ctx.measureText('A \\x0b B').width >= 200");
+
+    todo(ctx.measureText(' AB').width === 100, "ctx.measureText(' AB').width === 100");
+    todo(ctx.measureText('AB ').width === 100, "ctx.measureText('AB ').width === 100");
+}), 500);
+
+
+});
+</script>
+
